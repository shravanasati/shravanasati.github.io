<!doctype html><html lang=en><head><title>How Everything Suddenly Goes Berserk in Production</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.36e080bd5c38a8530af0f9a5ef6865a6b54d3c4ee19713271788ee3a70dce63d.css integrity="sha256-NuCAvVw4qFMK8Pml72hlprVNPE7hlxMnF4juOnDc5j0="><link rel=icon type=image/png href=/images/site/favicon_hud8d44aafaf58024f6b37e4c7de2adfb4_40926_42x0_resize_box_3.png><meta property="og:url" content="https://shravanasati.me/posts/production-berserk/"><meta property="og:site_name" content="Shravan Asati"><meta property="og:title" content="How Everything Suddenly Goes Berserk in Production"><meta property="og:description" content="This article talks about how shit unexpectedly blows up in the production environment, and a case study of how I brought back animeviz online."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-20T18:00:02+05:30"><meta property="article:modified_time" content="2024-06-20T18:00:02+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="How Everything Suddenly Goes Berserk in Production"><meta name=twitter:description content="This article talks about how shit unexpectedly blows up in the production environment, and a case study of how I brought back animeviz online."><meta name=description content="This article talks about how shit unexpectedly blows up in the production environment, and a case study of how I brought back animeviz online."><script data-goatcounter=https://softbubble.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hu271cdb825a04ec6e0718f49a091ec7cd_143559_42x0_resize_box_3.png id=logo alt=Logo>
Shravan Asati</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/#education>Education</a></li><li class=nav-item><a class=nav-link href=/#projects>Projects</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>More</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#recent-posts>Recent Posts</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class=nav-item><a class=nav-link href=/files/cv.pdf>Resume</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu271cdb825a04ec6e0718f49a091ec7cd_143559_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_huaf29acad7fdd78121b61745357f64982_215332_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a class=list-link href=/posts/selenium/ title="Infinite WPM with Python">Infinite WPM with Python</a></li><li><a class="active list-link" href=/posts/production-berserk/ title="Production Blunder">Production Blunder</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/posts/production-berserk/hero.jpg)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/shravan_hu723175651ee0a89b854711a46a667009_4543508_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>Shravan Asati</h5><p class=text-muted>Thursday, June 20, 2024 | 8 minutes</p></div><div class=title><h1>How Everything Suddenly Goes Berserk in Production</h1></div><div class=tags><ul style=padding-left:0></ul></div><div class=post-content id=post-content><p>I often tend to take a look at the websites I&rsquo;ve deployed - to check whether they are still online or not (I should use cutting edge tools like kubernetes). It also helps with the gloom that appears on my face when I view the website analytics.</p><p>One such time was the fine summer morning of 13th June 2024. I woke up late and checked my mobile for notifications (there weren&rsquo;t any). I decided to perform the health check of my websites. All of them were working fine, except <a href=https://animeviz.ninja target=_blank rel=noopener>animeviz</a>. When I opened it, it showed the default 502 Bad Gateway error page of nginx - which meant the python server was down. I was flabbergasted really - there weren&rsquo;t any recent code changes (last commit on the repository was almost 20 days ago). I kind of saw what was coming for me - a long debugging session. I slept back again and didn&rsquo;t start solving the problem until 11:30 AM.</p><div style=margin-top:2rem></div><h2 id=background>Background</h2><p>For those who don&rsquo;t know, <a href=https://animeviz.ninja target=_blank rel=noopener>animeviz</a> is a website that draws visualizations on your anime lists. It uses the <a href=https://myanimelist.net target=_blank rel=noopener>MyAnimeList</a> API to fetch user animelist, and then processes the data and draws some visualizations on it. The backend server is written in Python using the Flask library. It is deployed on a small DigitalOcean Droplet (1GB RAM, 25GB disk).</p><div style=margin-top:2rem></div><h2 id=investigation>Investigation</h2><p>I refreshed the page a couple more times and the result was <em>unexpectedly</em> the same ðŸ˜”. This meant the problem was something huge. I&rsquo;d rather not admit this, but animeviz has issues with memory leaks. Overtime, its memory usage just keeps increasing, reaching 100% when the Linux OOM (out of memory) killer kills the gunicorn process which is serving the site. This used to be a weekly occurence previously, and I had to manually SSH into the VPS and restart the server. Of course this wasn&rsquo;t ideal, I tried minimizing the memory leaks and modified the systemd service to restart the gunicorn process everytime it is shut down. This solved the downtime problem to a large extent and animeviz didn&rsquo;t go down in the last two months (until 13th June) since I made those changes.</p><p>The fact that animeviz was still down meant that the issue wasn&rsquo;t with memory leaks, since systemd would have already restarted it in that case. I quickly went over to the DigitalOcean dashboard and looked at the resource insights. The CPU has been maxing out since the last <strong>5 hours</strong> (from about 6:15am) and the memory graph was a zig zag curve wobbling between 50% and 70%. Yikes!</p><p>I quickly SSH&rsquo;d into the droplet and looked at the animeviz service logs using journalctl.</p><pre tabindex=0><code>sudo journalctl -u animeviz
</code></pre><p>This opened the service logs from the first line and I pressed <code>G</code> to navigate to the last line (vim keybindings work on the less pager). This operation took about 30s, and when I reached the end of the file, the line count showed a number around 9lakhs! The navigation in the file itself was proving very difficult and slow. I googled how to remove old logs in journalctl and found a command.</p><pre tabindex=0><code>sudo journalctl -u animeviz --vacuum-time 1d
</code></pre><p>This command removed all logs older than a day. Navigation was still slow (around 4 lakh lines remained). I still looked through the logs, the systemd restart counter was at <strong>200</strong> (ðŸ˜§). The same error was popping thorughout the logs, something related to mysql database connection. I was kind of relieved, since it was safe to assume that there wasn&rsquo;t anything wrong with <em>my</em> code. This was part of the traceback:</p><pre tabindex=0><code>Jun 13 10:50:30 animeviz gunicorn[879657]: sqlalchemy.exc.DatabaseError: (mysql.connector.errors.DatabaseError) 2003 (HY000): Can&#39;t connect to MySQL server on &#39;localhost:3306&#39; (111)
</code></pre><p>I checked the status of the mysql service.</p><pre tabindex=0><code>sudo systemctl status mysql
</code></pre><p>The status part showed &ldquo;Server upgrade in process&mldr;&rdquo;. Huh, that was confusing. I restarted both mysql and animeviz services. The situation didn&rsquo;t change. I powered off the droplet and powered it on again, to no avail. One of the most powerful tools under my belt had just failed, and about 20 mins have been lost.</p><p>I tried connecting with the database using the mysql client, as root.</p><pre tabindex=0><code>sudo mysql -u root
</code></pre><pre tabindex=0><code>&gt; Can&#39;t connect to MySQL server on &#39;localhost:3306&#39; (111)
</code></pre><p>So, I cannot connect with the official client either. That means the issue is definitely with the mysql server/daemon.</p><div style=margin-top:2rem></div><h2 id=the-culprit>The Culprit</h2><p>I checked the mysql logs using journalctl.</p><pre tabindex=0><code>sudo journalctl -u mysql
</code></pre><p>This is what those logs looked like:</p><pre tabindex=0><code>mysql.service: Scheduled restart job, restart counter is at 180.
Jun 13 11:26:36 animeviz systemd[1]: Stopped MySQL Community Server.
Jun 13 11:26:36 animeviz systemd[1]: mysql.service: Consumed 39.062s CPU time.
Jun 13 11:26:36 animeviz systemd[1]: Starting MySQL Community Server...
Jun 13 11:28:38 animeviz systemd[1]: mysql.service: Main process exited, code=exited, status=1/FAILURE
Jun 13 11:28:38 animeviz systemd[1]: mysql.service: Failed with result &#39;exit-code&#39;.
Jun 13 11:28:38 animeviz systemd[1]: Failed to start MySQL Community Server.
Jun 13 11:28:38 animeviz systemd[1]: mysql.service: Consumed 39.131s CPU time.
</code></pre><p>Notice the restart counter. I was quite annoyed to see that the <em>actual</em> error wasn&rsquo;t reported in these logs. I checked the service status again, and this time it had a different message similar to: &ldquo;Server upgrade failed, timeout due to lock&rdquo;.</p><p>I stopped the animeviz service since restarting them was just consuming more resources, and I had a hunch that the animeviz server, repeatedly trying to establish a connection with mysql might be interfering iwth the server upgrade.</p><p>I googled &ldquo;server upgrade in progress mysql&rdquo; and the first two links were forums titled <strong>&ldquo;MySQL stuck in an upgrade loop with high CPU usage&rdquo;</strong>. Jackpot ðŸ˜Ž.</p><blockquote><p>For the reader&rsquo;s reference: this is the <a href=https://forum.virtualmin.com/t/mysql-stuck-in-an-upgrade-loop-with-high-cpu-usage/112767 target=_blank rel=noopener>first</a> and <a href=https://serverfault.com/questions/1130794/mysql-stopped-working-on-ubuntu-22-04-failed-to-upgrade-server-error target=_blank rel=noopener>second</a> forum I found.</p></blockquote><p>In that first forum, I found out that mysql logs the <em>actual</em> errors in this file: <code>/var/log/mysql/error.log</code>.
I used the tail command given in the forum.</p><pre tabindex=0><code>tail /var/log/mysql/error.log
</code></pre><p>Since those logs were in the <code>/var</code> directory, I can&rsquo;t read them as of the writing date, but I vaguely remember it was along the lines of &ldquo;timeout due to locking&rdquo;. The error was not similar to the two forum posts.</p><p>Regardless, I thought I should pursue the steps given in the second forum (stack exchange always works ðŸ™‡). I followed these steps in order:</p><ol><li>Stopped the mysql service.</li></ol><pre tabindex=0><code>sudo systemctl stop mysql
</code></pre><ol start=2><li>Ran the server with minimal upgrade flag.</li></ol><pre tabindex=0><code>/usr/sbin/mysqld --upgrade minimal
</code></pre><p>As pointed out in the answer by <a href=https://serverfault.com/users/1020898/k-k-chauhan target=_blank rel=noopener>KK Chauhan</a>, the command failed, giving an error like unable to create sock file. They also answered that this could be solved by creating the following directory.</p><pre tabindex=0><code>sudo mkdir /var/run/mysqld
</code></pre><p>This wasn&rsquo;t enough (the server had the same error as above), I also had to change the ownership of this folder.</p><pre tabindex=0><code>sudo chown mysql:mysql /var/run/mysqld
</code></pre><p>I ran the mysql server again with the minimal upgrade flag. The server started this time! WOOHOO!
I tried connecting with the mysql client. That worked too. Now I felt like I was getting somewhere.
I stopped the server since this wasn&rsquo;t going to cut it: it was a hacky solution and in no time it would come to bite me again.</p><ol start=3><li>I created database backup.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>for</span> DB in <span style=color:#66d9ef>$(</span>mysql -u root -pPassword -e <span style=color:#e6db74>&#39;show databases&#39;</span> -s --skip-column-names<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>mysqldump -u root -pPassword $DB &gt; <span style=color:#e6db74>&#34;</span>$DB<span style=color:#e6db74>.sql&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>Backing up the database was necessary, since a couple of tables had rows in 4-5 digits.</p><ol start=4><li>I started the mysql service in hopes it would be back running.</li></ol><pre tabindex=0><code>sudo systemctl start mysql
</code></pre><p>My hopes were shattered. JournalCTL had superficial error logs. Again, as pointed in the stack exchange answer, I checked out the mysql error log file. And it showed the error same as that in the first forum! Talk about non-linear storytelling.</p><p>I went back to the first forum and read the solution (the OP answered it themselves). Basically, the error was about mysql failing to upgrade due to limited <code>thread_stack</code> size. I have no idea what that parameter is about. Regardless, I navigated to <code>/etc/mysql</code> directory to double the <code>thread_stack</code>. On <code>ls -R</code>, I noticed there were a lot of configuration files. I opened the <code>./mysql.conf.d/mysqld.cnf</code> file in vim and changed the <code>thread_stack</code> parameter from <code>128K</code>to <code>256K</code>.</p><p>As quickly as my hopes went up, they came crashing down as the mysql server didn&rsquo;t start and threw the same error at my face, again. I had a hunch that I&rsquo;d have to edit all the files with the <code>thread_stack</code> parameter.</p><p>So that&rsquo;s what I did. I searched all the files with the text <code>thread_stack</code> in the <code>/etc/mysql</code> directory.</p><pre tabindex=0><code>sudo grep thread_stack -R .
</code></pre><p>It showed three files - one of which I had already edited. I did the same change for the other two files. It had to work this time. If it didn&rsquo;t, I&rsquo;d have to purge mysql and reinstall (and re-setup), which is quite a lengthy process.</p><p><strong>The moment of truth</strong>: IT FINALLY WORKED!<br>And this time, fr, the server started.</p><p>I started the animeviz service too. Visited animeviz.ninja. It was live. After an hour.</p><p>One thing, which still remains a mystery is what caused the mysql server upgrade. Was it scheduled, or triggered by someone (ðŸ˜¨), or mysql suddenly decided it wants to upgrade? I&rsquo;d appreciate if some subject expert helped me resolve this question.</p><h2 id=bye>Bye</h2><p>That&rsquo;s all folks. I hope you guys enjoyed and learnt something from this blog. I think this would come in handy next time something like this happens, to me, or to anyone else.</p><p>(here&rsquo;s my <a href=https://m.do.co/c/54305c9231e8 target=_blank rel=noopener>referral link</a> for digitalocean, sign up using it, you get free credits, I get free credits)</p></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fshravanasati.me%2fposts%2fproduction-berserk%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fshravanasati.me%2fposts%2fproduction-berserk%2f&text=How%20Everything%20Suddenly%20Goes%20Berserk%20in%20Production&via=Shravan%20Asati" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fshravanasati.me%2fposts%2fproduction-berserk%2f&title=How%20Everything%20Suddenly%20Goes%20Berserk%20in%20Production" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fshravanasati.me%2fposts%2fproduction-berserk%2f&title=How%20Everything%20Suddenly%20Goes%20Berserk%20in%20Production" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=How%20Everything%20Suddenly%20Goes%20Berserk%20in%20Production https%3a%2f%2fshravanasati.me%2fposts%2fproduction-berserk%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=How%20Everything%20Suddenly%20Goes%20Berserk%20in%20Production&body=https%3a%2f%2fshravanasati.me%2fposts%2fproduction-berserk%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/shravanasati/shravanasati.github.io/edit/main/content/posts/production-berserk/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/selenium/ title="Achieving Infinite WPM in MonkeyType using Python" class="btn filled-button"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Achieving Infinite WPM in MonkeyType using Python</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#investigation>Investigation</a></li><li><a href=#the-culprit>The Culprit</a></li><li><a href=#bye>Bye</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:dev.shravan@proton.me target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>dev.shravan@proton.me</span></a></li><li><a href=https://github.com/shravanasati target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>shravanasati</span></a></li><li><a href=https://www.linkedin.com/in/shravan-asati target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Shravan Asati</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Â© 2024 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.100f2124055918d37ed55689f8b8cd9378a4ece97b585240e75bfd4894e0fe97.js integrity="sha256-EA8hJAVZGNN+1VaJ+LjNk3ik7Ol7WFJA51v9SJTg/pc=" defer></script></body></html>