<!doctype html><html lang=en><head><title>How I built an anonymous and exclusive social media website</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.c4374e24d57fc924d2a1349a630de105ce36f8a2ffac1c43f000a715a64d957a.css integrity="sha256-xDdOJNV/ySTSoTSaYw3hBc42+KL/rBxD8ACnFaZNlXo="><link rel=icon type=image/png href=/images/site/favicon_hu9036660780100762024.png><meta property="og:url" content="https://shravanasati.me/posts/everynyan-architecture/"><meta property="og:site_name" content="Shravan Asati"><meta property="og:title" content="How I built an anonymous and exclusive social media website"><meta property="og:description" content="This article talks about the architectural decisions behind everynyan."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-27T22:02:45+05:30"><meta property="article:modified_time" content="2024-12-27T22:02:45+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="How I built an anonymous and exclusive social media website"><meta name=twitter:description content="This article talks about the architectural decisions behind everynyan."><meta name=description content="This article talks about the architectural decisions behind everynyan."><script data-goatcounter=https://softbubble.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hu11188698498150164404.png id=logo alt=Logo>
Shravan Asati</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/#education>Education</a></li><li class=nav-item><a class=nav-link href=/#projects>Projects</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>More</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#recent-posts>Recent Posts</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class=nav-item><a class=nav-link href=/files/resume.pdf>Resume</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu11188698498150164404.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu9411445442247943367.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a class=list-link href=/posts/caesar-cipher/ title="Caesar Cipher">Caesar Cipher</a></li><li><a class="active list-link" href=/posts/everynyan-architecture/ title="EveryNyan Architecture">EveryNyan Architecture</a></li><li><a class=list-link href=/posts/selenium/ title="Infinite WPM with Python">Infinite WPM with Python</a></li><li><a class=list-link href=/posts/production-berserk/ title="Production Blunder">Production Blunder</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/posts/everynyan-architecture/hero.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/shravan_hu8616152671706420484.png alt="Author Image"><h5 class=author-name>Shravan Asati</h5><p class=text-muted>Friday, December 27, 2024 | 17 minutes</p></div><div class=title><h1>How I built an anonymous and exclusive social media website</h1></div><div class=tags><ul style=padding-left:0></ul></div><div class=post-content id=post-content><p>I&rsquo;ve been working on <a href=https://everynyan.tech target=_blank rel=noopener>EveryNyan</a>, an anonymous social media website exclusive to Adani University students for the past couple of months. This blog outlines some of the implementation details, architecture decisions behind it and the challenges we faced while working on this huge project.</p><p>The code which is being discussed in this blog can be found <a href=https://github.com/shravanasati/everynyan target=_blank rel=noopener>here</a>.</p><h3 id=the-idea>The Idea</h3><p>Inspired by the movie Social Network, me and my friend <a href=https://ni3rav.me target=_blank rel=noopener>Nirav</a> thought of working on a social media website exclusive for our institute&rsquo;s students - with a twist - everything would be <strong>anonymous</strong>. The core feature of the website would be to create posts on certain boards (eg. confessions, gyan, random&mldr;), where other users could vote them (up or down) and write comments on the post. If it sounds a lot like 4chan and reddit, your observations are astute.</p><h3 id=tech-stack>Tech Stack</h3><p>For the website, we decided to use <a href=https://nextjs.org target=_blank rel=noopener>Next.js</a>, since using react alone has been a painful experience for both of us. Next.js tooling is pretty good (except for the initial build times) so we ended up using it. When we started working on the project, the latest Next version was 14, and we still use it, without any plans to upgrade to Next15 in the near future.</p><p>The integration of Next with <a href=https://ui.shadcn.com target=_blank rel=noopener>shadcn</a> & <a href=https://v0.dev target=_blank rel=noopener>v0</a> is also pretty neat.</p><p>For the database, we chose Firestore on a whim, and regret that decision now (more on that later).</p><p>The notifications service is written in Go which primarily uses boltdb, and an under-development automatic content-moderation service in Python.</p><h3 id=anonymity-and-exclusivity>Anonymity and Exclusivity</h3><p>The biggest challenge in the beginning was authentication - how do I make sure only students of my institute can login on the platform, without revealing their identities.
I thought long and hard about it, and after several rounds of discussion with LLMs, I went ahead with a seemingly simple solution - OTPs.</p><p>Every student of the institute has an email address of this form: <code>name.branchYear@adaniuni.ac.in</code>, I could send OTPs to this email to ensure only a specific set of students can login on the platform.</p><p>Once the OTP is verified, a random token is generated (a UUID) and stored on cookies as well as the database. The email is only stored in the OTPs collections on the database, and not on the tokens collection.</p><p>Thus, we only know who has signed up on the platform, but each login session is independent of the email - there&rsquo;s no way to backtrack a post or a comment author to the email with which the user had logged in.</p><p>This is a screenshot of a sample document from the OTPs collection (the actual OTP is hashed).</p><img src=/posts/everynyan-architecture/otp.png alt="an image of otp doc from the database"><div style=margin-top:1rem></div><p>And this is a screenshot of a sample document from the tokens collection.</p><img src=/posts/everynyan-architecture/token.png alt="an image of token doc from the database"><div style=margin-top:1rem></div><p>The <code>role</code> field can be either <code>admin</code> or <code>user</code> and is decided during the sign-in process based on the email. An <code>admin</code> user has special privileges - like access to the admin panel (more on that later).</p><p>For sending these OTP emails, I opted using the <a href=https://resend.dev target=_blank rel=noopener>Resend</a> API, it has great docs and library support, and with the <code>react-email</code> library, the email content can be a simple react component!</p><p>Everytime a login process is initiated, the email is first validated using a regular expression. If it passes the validation, an OTP is generated, stored on the database with the given email and an email is sent to the user.</p><p>If the above process was successfull, the user is redirected to a page where they can verify the OTP. If the verification is successfull, they are finally logged in on the platform.</p><p>Each login session initially lasts for 14 days, but upon subsequent requests, the session lifetime keeps increasing.</p><h3 id=lots-of-crud-operations>Lots of CRUD operations</h3><p>What followed the implementation of role-based authentication is boring - lots of CRUD operations - for posts, comments, voting, and reports.</p><h4 id=flow>Flow</h4><p>It was quite simple really - I followed this abstraction strategy for all user interactions with the database.</p><p>Step 1: Write appropriate database functions in <code>lib/firebase</code> using the firebase-admin sdk.</p><p>Step 2: Create server actions for the same in <code>lib/actions</code>, which typically consist of user authentication, and calling the database functions.</p><p>Step 3: Create react components in the <code>components</code> directory, which use the server actions (if applicable).</p><p>Step 4: Use those components in the app router.</p><p>This was pretty much the flow for all user interactions with the website. Some of them contained extensive client side code as well - especially the feed component which has lazy loading behavior for posts.</p><p>Forgot to mention: posts support markdown. We used the <code>MDX</code> library for the markdown editor and and the <code>react-markdown</code> library for rendering the markdown in the post page.</p><h4 id=post-urls>Post URLs</h4><p>This is not really interesting but I want to mention it anyway - how post slugs are generated. Basically, each post has an ID, which is the only way to identify the post. But once a post is created, its URL might look like this: <code>https://everynyan.tech/post/jus_parody_of_a_song_r3xyny</code>. It is a combination of the first few alphanumeric characters of the title and the post ID. When this endpoint is hit, the server only reads the last 6 characters of the slug - which is the ID of the post. Yeah I stole this idea from reddit. It is quite nice tho - users can see kinda see what the post is about just from the URL.</p><h4 id=comments>Comments</h4><p>Rendering comments was quite challenging too. In Firestore, they are stored in a flat structure in the comments collection of each post. Each comment has a parent ID, which is <code>null</code> for top-level comments and the ID of the parent comment for replies. LLMs came to the rescue - I knew I&rsquo;d have to use a tree data structure but I wasn&rsquo;t sure how. I still don&rsquo;t understand how <em>exactly</em> the comments are being rendered along with their replies.</p><h4 id=admin-panel>Admin Panel</h4><p>The admin panel has four main components - a section to show total logged-in and current active users, a section to resolve reports, a section to broadcast notifications and a section to view security logs.</p><p>It is only accesible to users with the <code>admin</code> role.</p><h4 id=feed>Feed</h4><p>Initially, there wasn&rsquo;t a &lsquo;feed&rsquo; on EveryNyan, and the only way to browse posts was to go to the specific board page (<code>/board/confessions</code> for example). This wasn&rsquo;t ideal - even I was tired of navigating between different boards to look for new posts.</p><p>So, we worked on a feed component which is similar to the board feed, except it gathers posts from all the boards. We also added sorting options in the feed - latest, popular, controversial, and engaging, similar to reddit.</p><p>The feed is shown on the root endpoint (<code>/</code>) to logged-in users.</p><h3 id=why-a-rdbms-would-be-better>Why a RDBMS would be better</h3><p>I earlier mentioned that we regret using Firestore as the primary database. It&rsquo;s because PostgreSQL is just that much better. Document databases often advertise their flexibility and the lack of schema as their main selling point. I really don&rsquo;t get it. It allows you to not think about the structure of your data properly. Yeah this happened quite some times while working on EveryNyan. Also querying in Firestore is weird. I prefer SQL (Sexy Query Language).</p><p>The easy setup is nice but there&rsquo;s also ambiguity with the client and admin SDKs. Initially I was using the &ldquo;web&rdquo; <abbr title="Software Development Kit">SDK</abbr> which is meant to run from the client-side, but I am interacting with the database only on the server side. This later conflicted with the security rules thing. Maybe I&rsquo;m just stupid but I find it hard to see any advantages in communicating with the database from the client side. I later had to go through the trouble of generating a service account key and switched to the &ldquo;admin&rdquo; SDK. This created another problem - turns out I was using some of the firebase code directly on the client side with client components in Nextjs. When I switched to the admin SDK, some &ldquo;server&rdquo; code was essentially running on client side (which obviously lacks Node standard library) and there were lots of weird import errors. This was a nice learning experience though - I learnt loads about Nextjs.</p><p>This is not really a negative point since Firebase is quite cheap but I still don&rsquo;t want to pay for database when I can host it for free on a <abbr title="Virtual Private Server">VPS</abbr> (I have lots of free credits). Cloud functions are available only on the paid plan. And there are also limited read and writes, although we&rsquo;re yet to hit the limit yet.</p><p>Search is a feature I&rsquo;m excited to implement in EveryNyan. It requires a search engine. There are lots of them in the market - elasticsearch, meilisearch, etc. Search engines need to integrate with the database so they can keep their indexes up-to-date. To do this in Firestore, you need to be on a paid plan. Postgres has native support for Full-Text-Search. If you&rsquo;ve a self-hosted instance, you also needn&rsquo;t worry about hitting the read-write limits.</p><p>That&rsquo;s why a SQL migration is planned, but I&rsquo;m not sure when I will do it since it&rsquo;s quite a massive undertaking. Not only all the database code needs to be re-written, I need to migrate existing data from Firestore as well.</p><h3 id=notifications>Notifications</h3><p>When we first launched EveryNyan publicly, we had great response. We crossed 100 sign-ups within several days even without significant marketing. It was very lively. Confessions, rants and controversial posts here and there. It seemed like the only way forward was upwards.</p><p>User activity was down by 90% the next week. We had a terribly low user retention. We quickly realized that people are not reopening EveryNyan - rightfully so - people were not yet addicted to it. The only way to re-engage users was notifications. &ldquo;Someone liked your reply 👍&rdquo;, &ldquo;Someone commented on your post 😜&rdquo;, &ldquo;You&rsquo;re getting ratio&rsquo;d 😲&rdquo; was much needed. Nothing more exciting than fresh notifications disturbing you during productive periods.</p><p>Thus began a sweat-inducing, greuling journey to claw EveryNyan back from the brink of irrelevance. Notifications was definitely the biggest and hardest feature to implement so far.</p><p>This is what I came up with: there would be two kinds of notifications.</p><ul><li><p>Notifications Center</p><p>These notifications will be shown behind a bell icon on the navbar and the dock, and will be visible only when the user opens the notifications page. These will be stored in the database and hence will be persistent.</p></li><li><p>Realtime notifications</p><p>These notifications will be delivered instantly to the user via two channels:</p><ul><li><p>In-app notifications:
These will be shown using toasts. Everytime the website is loaded, a websocket connection with the notifications service will be established. It will then listen for notifications, and show them using toasts whenever the notifications service sends it one.</p></li><li><p>Push notifications:
Push notifications are delivered to the user&rsquo;s device regardless of whether the website/app (<abbr title="Progressive Web App">PWA</abbr>) is open or not. The user first needs to grant the website permission to show notifications. But it is a great way to increase user engagement. Since EveryNyan already had a PWA, I just had to add custom service worker code to react to push notification events.</p></li></ul></li></ul><p>This was my initial architecture design for the notifications service. I chose Go for it because I felt like it.</p><img src=/posts/everynyan-architecture/notifications.png alt="initially planned notifications system architecture"><div style=margin-top:1rem></div><p><strong>Spoiler alert</strong>: I didn&rsquo;t add a message queue because</p><ol><li>I thought it would be overengineering for an app of this scale (barely hundred users)</li><li>I was lazy</li></ol><h4 id=notifications-center>Notifications Center</h4><p>I started with the notifications center since it was easier to implement.</p><p>First things first, posts and comments didn&rsquo;t have an author field before - shit was truly anonymous. But to make notifications possible, we need to know which &ldquo;user&rdquo; (&ldquo;token&rdquo; to be technically accurate) wrote a certain post or comment. So, I added an author field to post and comment types, and when these are created, the session token is added in the &lsquo;author&rsquo; field.</p><p>Currently, automated notifications are created only on comments. When a comment is written, the post author, and all the parent comment authors in the comment chain (if applicable) are eligible to be notified. Once all the notifiable users are fetched, the notifications collection on firestore is filled with documents with this type.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NotificationType</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>user</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;unread&#34;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#34;read&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>link</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, I created a notifications page which fetches all the documents in the notifications collection where user is the current user and status is unread. Once the page is opened, all unread notifications are marked as read.</p><p>I also added the notification bell icon on the dock and the navbar. The dock icon also shows the unread notification count.</p><h4 id=realtime-notifications>Realtime Notifications</h4><p>Realtime notifications are handled by a separate service written in Go. The code can be found <a href=https://github.com/shravanasati/everynyan-notification-service target=_blank rel=noopener>here</a>.</p><h5 id=in-app-notifications>In App Notifications</h5><p>As discussed above, in-app notifications are delivered via websockets. Everytime the website is loaded, a websocket connection is established with the notifications server which is hosted at <code>notifications.everynyan.tech</code>. The server first authenticates the user using firebase. If the authentication is successfull, it adds the websocket connection to a list of active connections.</p><p>Whenever a notification is created, the Next.js server sends a HTTP POST request to this Go server. The request data contains an array of notification object, each having a title, description, link and the user it is targeted to. For each notification object, if the target user is currently online (i.e., the websocket connection exists), a JSON message is sent to it. The client reads the message and shows a toast to the user.</p><p>This was not <em>very</em> hard to implement but I had some nasty issues.</p><ol><li><p>The cookies were not sent from the browser to the notifications service. This was causing authentication failure and all subscription requests were being rejected. After a lot of searching, I came to know that cookies are not sent even to subdomains by default. The fix was to add a <code>Domain</code> attribute while setting cookies with the value <code>everynyan.tech</code>. Now, cookies will be sent to subdomains of <code>everynyan.tech</code> as well.</p></li><li><p>The notifications service sits behind a Nginx reverse proxy. Nginx doesn&rsquo;t accept websocket connections by default. I didn&rsquo;t know much about the nginx configuration so I hacked it together with the help of stackoverflow. I made the following changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://localhost:7924</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># websocket support
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>proxy_http_version</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>.1</span>;
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Upgrade</span> $http_upgrade;
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Connection</span> <span style=color:#e6db74>&#34;upgrade&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><div style=margin-top:1rem></div><ol start=3><li>The websocket connections were being dropped after exactly 30s, for no apparent reason. To solve this, I implemented a heartbeat mechanism in which the client and server exchange ping-pong messages every 15s. I didn&rsquo;t debug the exact cause of this issue, I have a hunch this too might be due to some misconfiguration.</li></ol><h5 id=push-notifications>Push Notifications</h5><p>This was the most painful experience I&rsquo;ve ever had in my entire programming career.</p><p>For all the features EveryNyan has had yet, I&rsquo;ve had the general idea on how to implement them. Since push notifications was a completely new topic for me, I had no idea how to do it. Lots of reading ensued. MDN had great articles on implementing the client-side of push notifications, and for the server-side I had to make do with the webpush library docs. This is the Go <a href=https://github.com/SherClockHolmes/webpush-go target=_blank rel=noopener>library</a> I used. Its docs were minimal, so I also looked up docs for an equivalent library in Python. It explained the webpush and VAPID flow better. For the next-specific implementation, I borrowed some code from this <a href=https://github.com/david-randoll/push-notification-nextjs/tree/main target=_blank rel=noopener>repo</a> as well.</p><p>Since I kind of understand it now, let me break it down.</p><p>Push notifications are delivered using the webpush protocol. The webpush protocol ensures end-to-end encryption of messages so that only the browser can read it. The authentication is performed using a pair <abbr title="Voluntary Application Identification"><strong>VAPID</strong></abbr> keys. The public key is shared with the browser and the private key is kept only on the server.</p><h6 id=client-side-implementation>Client side implementation</h6><p>A <a href=https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API target=_blank rel=noopener>service worker</a> must be registered which listens for the push event. A service worker is basically some code which is executed in the background by the browser. It runs in a different thread and has <strong>no</strong> access to the DOM or other browser APIs like <code>fetch</code> and <code>WebStorage</code>. It can only react to events.</p><p>Once a service worker is installed and running, it can react to events.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;push&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Push received...&#39;</span>, <span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>registration</span>.<span style=color:#a6e22e>showNotification</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>title</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>body</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>icon</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>icon</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>But before notifications can be shown to users, the user must grant the website permission to show notifications. One caveat with requesting this permission is to do it in response to a user gesture. Some browsers like Firefox outright reject the request if it wasn&rsquo;t done in response to a user gesture, and Chrome has plans to do the same. In EveryNyan, if a user hasn&rsquo;t granted this permission, a toast is shown to them with a &lsquo;subscribe&rsquo; button.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>requestNotificationPermission</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Notification</span>.<span style=color:#a6e22e>requestPermission</span>().<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>permission</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>permission</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;granted&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>subscribeUserToPush</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Once the permission is granted, the <code>subscribeUserToPush</code> function might look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>subscribeUserToPush</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>serviceWorker</span>.<span style=color:#a6e22e>ready</span>.<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>registration</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>subscribeOptions</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userVisibleOnly</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>applicationServerKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>urlBase64ToUint8Array</span>(<span style=color:#a6e22e>publicVapidKey</span>)
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>registration</span>.<span style=color:#a6e22e>pushManager</span>.<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>subscribeOptions</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>pushSubscription</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Received PushSubscription:&#39;</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>pushSubscription</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sendSubscriptionToServer</span>(<span style=color:#a6e22e>pushSubscription</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The push manager returns a <strong>subscription</strong> object which looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#f92672>&#34;endpoint&#34;</span>: <span style=color:#e6db74>&#34;an endpoint URL...&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#f92672>&#34;keys&#34;</span>: {
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;auth&#34;</span>:   <span style=color:#e6db74>&#34;auth key&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;p256dh&#34;</span>: <span style=color:#e6db74>&#34;p256dh key&#34;</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>endpoint</code> is an URL for the push service where our server will send notifications. Each browser vendor maintains their own push service which acts as an intermediary between the browser and server. It checks the VAPID signatures, maintains a message queue if the browser is offline, and finally relays the message to the appropriate service worker. For example, Chrome has FCM, and Mozilla has autopush.</p><p>Once the subscription is created, it needs to be sent to the notifications server.</p><h6 id=server-side-implementation>Server side implementation</h6><p>The notifications server receives the push subscription and stores it on a persistent database, which is <a href=https://github.com/boltdb/bolt target=_blank rel=noopener>BoltDB</a> in this case. I used it because a key-value pair is all I needed, the user token and the push subscription.</p><p>The code for sending push notifications is pretty minimal, the webpush-go library does all the heavy lifting.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>_sendPushNotificationBytes</span>(<span style=color:#a6e22e>message</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>subscription</span> <span style=color:#a6e22e>webpush</span>.<span style=color:#a6e22e>Subscription</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;sending this push notification:&#34;</span>, string(<span style=color:#a6e22e>message</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>webpush</span>.<span style=color:#a6e22e>SendNotification</span>(<span style=color:#a6e22e>message</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>subscription</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>webpush</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Subscriber</span>: <span style=color:#e6db74>&#34;dev.shravan@proton.me&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>VAPIDPublicKey</span>: <span style=color:#a6e22e>vapidPublicKey</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>VAPIDPrivateKey</span>: <span style=color:#a6e22e>vapidPrivateKey</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Urgency</span>: <span style=color:#a6e22e>webpush</span>.<span style=color:#a6e22e>UrgencyNormal</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;unable to send push notification&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Internally, the library encrypts the content using the subscription keys, and prepares a HTTP request to the subscription endpoint (the push service).</p><h6 id=challenges>Challenges</h6><p>This might become a bit repetitive but this <em>unexpectedly</em> also did not work on the first try. The issues I encountered this time were:</p><ol><li>Initially, push subscription was being sent directly to the notifications service from the browser. And ofcourse CORS was a pain in the ass. Despite many attempts to fix it, it still wouldn&rsquo;t go away, despite the websocket connection was being successfully established with the service. I don&rsquo;t understand how a GET request works but POST wouldn&rsquo;t even though I specified it in the next config file.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>headers</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>source</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/(.*)&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Access-Control-Allow-Origin&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>notificationsServerAddress</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Access-Control-Allow-Methods&#34;</span>, <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET, POST, OPTIONS&#34;</span> },
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Access-Control-Allow-Headers&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;Content-Type, Authorization, Content-Length, X-Requested-With&#34;</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Access-Control-Allow-Credentials&#34;</span>, <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;true&#34;</span> },
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>I gave up and made a new API route at the endpoint <code>/api/subscription</code>, and then sent the user token and the subscription object to the notifications service from nextjs server.</p><ol start=2><li>This was a very stupid mistake. In the push event handler of the service worker, I was re-parsing the json object, which returned <code>undefined</code>. Notifications were thus not being shown properly. I hate javascript.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;push&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>json</span>());
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Push received...&#39;</span>, <span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The fix was simple, I just removed <code>JSON.parse</code>.</p><h4 id=broadcast>Broadcast</h4><p>The admin panel has a broadcast section as well - from which an admin can broadcast realtime notifications, both in-app and push ones to all the users. Its implementation is also similar, instead of targeting a user, the Go service sends the given notification to all the subscribers. I currently use it to send zomato-style notifications about the hottest post of the day, although I plan to automate it too.</p><h3 id=automod>Automod</h3><p>Moderating content manually is tiring. The moderation service will be responsible for automatically moderating posts and comments on the platform, to prevent excessive toxicity. The problem is that all the pre-trained models I&rsquo;ve tried so far don&rsquo;t seem to fit our requirements. We want a certain level of toxicity on the platform, otherwise it would be boring. Then there&rsquo;s also an issue with Hindi, none of the models seem to understand Hindi. I tried integrating translation services but the results were not upto the par.</p><p>After discussions with multiple ML experts, the conclusion we&rsquo;ve arrived to is to make our own model using our own data. This would be a great learning experience.</p><p>The code written for this service so far can be found in this <a href=https://github.com/shravanasati/everynyan-moderation-service target=_blank rel=noopener>repo</a>.</p><h3 id=planned-features>Planned Features</h3><p>We&rsquo;ve certainly ticked all the boxes for EveryNyan&rsquo;s MVP. The project is however far from over. There are so many features that are under progress and in the planning stage. The ones I&rsquo;m most excited about is GIF support, images support, search and active users 😭.</p><p>This was quite a long read. Thanks for reading so far. If you&rsquo;ve any questions or suggestions, I&rsquo;m all <a href=https://shravanasati.me#about target=_blank rel=noopener>ears</a>.</p></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fshravanasati.me%2fposts%2feverynyan-architecture%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fshravanasati.me%2fposts%2feverynyan-architecture%2f&text=How%20I%20built%20an%20anonymous%20and%20exclusive%20social%20media%20website&via=Shravan%20Asati" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fshravanasati.me%2fposts%2feverynyan-architecture%2f&title=How%20I%20built%20an%20anonymous%20and%20exclusive%20social%20media%20website" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fshravanasati.me%2fposts%2feverynyan-architecture%2f&title=How%20I%20built%20an%20anonymous%20and%20exclusive%20social%20media%20website" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=How%20I%20built%20an%20anonymous%20and%20exclusive%20social%20media%20website https%3a%2f%2fshravanasati.me%2fposts%2feverynyan-architecture%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=How%20I%20built%20an%20anonymous%20and%20exclusive%20social%20media%20website&body=https%3a%2f%2fshravanasati.me%2fposts%2feverynyan-architecture%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/shravanasati/shravanasati.github.io/edit/main/content/posts/everynyan-architecture/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/caesar-cipher/ title="Understanding and breaking the Caesar cipher" class="btn filled-button"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Understanding and breaking the Caesar cipher</div></a></div><div class="col-md-6 next-article"><a href=/posts/selenium/ title="Achieving Infinite WPM in MonkeyType using Python" class="btn filled-button"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Achieving Infinite WPM in MonkeyType using Python</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#the-idea>The Idea</a></li><li><a href=#tech-stack>Tech Stack</a></li><li><a href=#anonymity-and-exclusivity>Anonymity and Exclusivity</a></li><li><a href=#lots-of-crud-operations>Lots of CRUD operations</a><ul><li><a href=#flow>Flow</a></li><li><a href=#post-urls>Post URLs</a></li><li><a href=#comments>Comments</a></li><li><a href=#admin-panel>Admin Panel</a></li><li><a href=#feed>Feed</a></li></ul></li><li><a href=#why-a-rdbms-would-be-better>Why a RDBMS would be better</a></li><li><a href=#notifications>Notifications</a><ul><li><a href=#notifications-center>Notifications Center</a></li><li><a href=#realtime-notifications>Realtime Notifications</a><ul><li><a href=#in-app-notifications>In App Notifications</a></li><li><a href=#push-notifications>Push Notifications</a><ul><li><a href=#client-side-implementation>Client side implementation</a></li><li><a href=#server-side-implementation>Server side implementation</a></li><li><a href=#challenges>Challenges</a></li></ul></li></ul></li><li><a href=#broadcast>Broadcast</a></li></ul></li><li><a href=#automod>Automod</a></li><li><a href=#planned-features>Planned Features</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=https://shravanasati.me/#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:dev.shravan@proton.me target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>dev.shravan@proton.me</span></a></li><li><a href=https://github.com/shravanasati target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>shravanasati</span></a></li><li><a href=https://www.linkedin.com/in/shravan-asati target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Shravan Asati</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu16779671404603505019.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2024 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.700a729646982d05db233c060bae3ecb7894e5b5fe9e1f168140d4702e1dbaa8.js integrity="sha256-cApylkaYLQXbIzwGC64+y3iU5bX+nh8WgUDUcC4duqg=" defer></script></body></html>